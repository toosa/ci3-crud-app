# Nginx configuration for CodeIgniter 3 CRUD Application
# Place this in your main nginx.conf or as a separate site config

server {
    listen 80;
    server_name localhost;  # Change this to your domain if needed
    
    # Document root
    root /var/www/html;
    index index.php index.html index.htm;
    
    # Logging
    access_log /var/log/nginx/ci3webapp_access.log;
    error_log /var/log/nginx/ci3webapp_error.log;
    
    # CI3 application location block
    location /ci3webapp {
        alias /var/www/html/ci3webapp;
        
        # Try files in order: exact file, directory, then route to CodeIgniter
        try_files $uri $uri/ @ci3rewrite;
        
        # Handle PHP files
        location ~ \.php$ {
            include fastcgi_params;
            fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;  # Adjust PHP version as needed
            fastcgi_param SCRIPT_FILENAME $request_filename;
            fastcgi_param PATH_INFO $fastcgi_path_info;
        }
    }
    
    # CodeIgniter URL rewriting
    location @ci3rewrite {
        rewrite ^/ci3webapp/(.+)$ /ci3webapp/index.php/$1 last;
    }
    
    # Deny access to CodeIgniter system directory
    location ~ ^/ci3webapp/(application|system)/ {
        deny all;
        return 403;
    }
    
    # Deny access to sensitive files
    location ~ ^/ci3webapp/(.*)/(config|cache|logs)/ {
        deny all;
        return 403;
    }
    
    # Handle static assets
    location ~* ^/ci3webapp/.+\.(css|js|jpg|jpeg|gif|png|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
}

# Alternative configuration if you want ci3webapp as a subdomain
# server {
#     listen 80;
#     server_name ci3webapp.localhost;  # Add to /etc/hosts: 127.0.0.1 ci3webapp.localhost
#     
#     root /var/www/html/ci3webapp;
#     index index.php index.html index.htm;
#     
#     location / {
#         try_files $uri $uri/ /index.php$is_args$args;
#     }
#     
#     location ~ \.php$ {
#         include fastcgi_params;
#         fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
#         fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
#     }
#     
#     location ~ ^/(application|system)/ {
#         deny all;
#         return 403;
#     }
# }